<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiques - Le Petit Marché</title>
    <link rel="stylesheet" href="{{url_for('static', filename='css/produits.css')}}">
    <script src="{{url_for('static', filename='js/scripts.js')}}" defer></script>
</head>
<body>
    <!-- Header -->
    <header>
        <h1>Chiques</h1>
        <a href="{{url_for('main.menu')}}" class="btn-go-home">Retour à la boutique</a>
    </header>

    <!-- Liste des produits -->
    <div id="products-container">
        {% for produit in produits %}
        <div class="product">
            <h3>{{ produit.name }}</h3>
            <p>Prix: {{ produit.price }}€</p>
            <p>Stock: {{ produit.stock }}</p>
             <!-- Quantité -->
             <div class="quantity">
                <button class="decrease" data-id="{{ produit.id }}">-</button>
                <span class="quantity-text">1</span>
                <button class="increase" data-id="{{ produit.id }}">+</button>
            </div>

            <button class="add-to-cart" data-id="{{ produit.id }}">Ajouter au panier</button>
        </div>
    {% endfor %}
    </div>

    <!-- Affichage du panier -->
    <div class="cart">
        <a href="{{url_for('main.cart')}}" class="cart-link">Voir mon panier</a>
    </div>
    <script src="{{url_for('static',filename='js/scripts.js')}}"></script>
    <script>
        function loadProductsFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const categorie = urlParams.get("categorie");

    if (!categorie) {
        console.error("Aucune catégorie spécifiée dans l'URL.");
        return;
    }

    console.log("Catégorie extraite de l'URL :", categorie);

    fetch(`/api/produits?categorie=${categorie}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById("products-container");
            if (!container) return;
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "Aucun produit trouvé pour cette catégorie.";
                return;
            }

            data.forEach(product => {
                const productDiv = document.createElement("div");
                productDiv.classList.add("product");
                productDiv.innerHTML = `
                    <h3>${product.name}</h3>
                    <p>Prix: ${product.price}€</p>
                    <p>Stock: ${product.stock}</p>
                    
                    <!-- Quantité -->
                    <div class="quantity">
                        <button class="decrease" data-id="${product.id}">-</button>
                        <span class="quantity-text">1</span>
                        <button class="increase" data-id="${product.id}">+</button>
                    </div>
                    
                    <!-- Ajouter au panier -->
                    <button class="add-to-cart" data-id="${product.id}">Ajouter au panier</button>
                `;
                container.appendChild(productDiv);
            });

            attachQuantityEvents();  // Attache les événements pour la quantité
            attachAddToCartEvents(); // Attache les événements pour ajouter au panier
        })
        .catch(error => console.error("Erreur lors du chargement des produits :", error));
}

// Fonction pour attacher les événements "Ajouter au panier"
function attachAddToCartEvents() {
    document.querySelectorAll(".add-to-cart").forEach(button => {
        button.addEventListener("click", (e) => {
            const productId = parseInt(e.target.getAttribute("data-id"));
            const quantity = parseInt(e.target.previousElementSibling.querySelector('.quantity-text').textContent);
            addProductToCart(productId, quantity);
        });
    });
}

// Fonction pour ajouter un produit au panier
function addProductToCart(productId, quantity) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const productIndex = cart.findIndex(product => product.id === productId);

    if (productIndex === -1) {
        cart.push({ id: productId, quantity: quantity });
    } else {
        cart[productIndex].quantity += quantity;
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
}

// Fonction pour mettre à jour le nombre d'articles dans le panier
function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartCount = cart.reduce((total, product) => total + product.quantity, 0);
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
        cartCountElement.textContent = cartCount;
    }
}

// Fonction pour gérer l'ajustement de la quantité
function attachQuantityEvents() {
    document.querySelectorAll('.increase').forEach(button => {
        button.addEventListener('click', (e) => {
            const quantitySpan = e.target.previousElementSibling;
            let currentQuantity = parseInt(quantitySpan.textContent);
            if (currentQuantity < 99) {  // Limiter à 99 produits
                quantitySpan.textContent = currentQuantity + 1;
            }
        });
    });

    document.querySelectorAll('.decrease').forEach(button => {
        button.addEventListener('click', (e) => {
            const quantitySpan = e.target.nextElementSibling;
            let currentQuantity = parseInt(quantitySpan.textContent);
            if (currentQuantity > 1) {  // Ne pas descendre en dessous de 1
                quantitySpan.textContent = currentQuantity - 1;
            }
        });
    });
}

// Lancer la fonction après le chargement de la page
document.addEventListener("DOMContentLoaded", loadProductsFromURL);

    </script>
</body>
</html>
