<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grignotages - Le Petit Marché</title>
    <link rel="stylesheet" href="{{url_for('static', filename='css/produits.css')}}">
    <script src="{{url_for('static',filename='js/scripts.js')}}" defer></script>
</head>
<body>
    <!-- Header -->
    <header>
        <h1>Grignotages</h1>
        <a href="{{url_for('main.menu')}}" class="btn-go-home">Retour à la boutique</a>
    </header>

    <!-- Liste des produits -->
    <div id="products-container">
        {% for produit in produits %}
            <div class="product">
                <h3>{{ produit.name }}</h3>
                <p>Prix: {{ produit.price }}€</p>
                <p>Stock: {{ produit.stock }}</p>
                <button class="add-to-cart" data-id="{{ produit.id }}">Ajouter au panier</button>
            </div>
        {% endfor %}
    </div>

    <!-- Affichage du panier -->
    <div class="cart">
        <a href="{{url_for('main.cart')}}" class="cart-link">Voir mon panier</a>
    </div>
    <script src="{{url_for('static',filename='js/scripts.js')}}"></script>
    <script>
        // Fonction pour charger les produits en fonction de la catégorie dans l'URL
        function loadProductsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const categorie = urlParams.get("categorie"); // Récupère la catégorie de l'URL

            if (!categorie) {
                console.error("Aucune catégorie spécifiée dans l'URL.");
                return;
            }

            console.log("Catégorie extraite de l'URL :", categorie);

            // Appel de l'API Flask pour récupérer les produits de cette catégorie
            fetch(`/api/produits?categorie=${categorie}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("products-container");
                    if (!container) return;
                    container.innerHTML = "";

                    if (data.length === 0) {
                        container.innerHTML = "Aucun produit trouvé pour cette catégorie.";
                        return;
                    }

                    data.forEach(product => {
                        const productDiv = document.createElement("div");
                        productDiv.classList.add("product");
                        productDiv.innerHTML = `
                            <h3>${product.name}</h3>
                            <p>Prix: ${product.price}€</p>
                            <p>Stock: ${product.stock}</p>
                            <button class="add-to-cart" data-id="${product.id}">Ajouter au panier</button>
                        `;
                        container.appendChild(productDiv);
                    });

                    // Attache les événements après le chargement des produits
                    attachAddToCartEvents();
                })
                .catch(error => console.error("Erreur lors du chargement des produits :", error));
        }

        // Fonction pour attacher les événements "Ajouter au panier"
        function attachAddToCartEvents() {
            if (document.querySelectorAll(".add-to-cart").length === 0) return;
            document.querySelectorAll(".add-to-cart").forEach(button => {
                button.addEventListener("click", (e) => {
                    const productId = parseInt(e.target.getAttribute("data-id"));
                    addProductToCart(productId);
                });
            });
        }

        // Fonction pour ajouter un produit au panier
        function addProductToCart(productId) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const productIndex = cart.findIndex(product => product.id === productId);

            if (productIndex === -1) {
                cart.push({ id: productId, quantity: 1 });
            } else {
                cart[productIndex].quantity++;
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount(); // Mise à jour du nombre d'articles
        }

        // Fonction pour mettre à jour le nombre d'articles dans le panier
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartCount = cart.reduce((total, product) => total + product.quantity, 0);
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = cartCount;
            }
        }

        // Lancement de la fonction de chargement des produits après le chargement de la page
        document.addEventListener("DOMContentLoaded", loadProductsFromURL);
    </script>
    
</body>
</html>
